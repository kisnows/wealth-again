# 收入预测显示优化

## 需求描述

根据用户反馈，需要优化收入预测的显示方式：

1. **收入合并计算**：所有奖金和工资都在自然月月底合并发放，共同计算税费和社保
2. **表格优化**：使用新的表头结构，清晰显示收入构成和扣除明细
3. **图表简化**：柱状图只显示税前税后总收入，折线图显示累计收入趋势
4. **奖金发放逻辑**：例如 2025 年 8 月 19 日的奖金会与 8 月工资合并，作为 8 月总收入计算

## 完成的修改

### 1. 更新需求文档 ✅

- 在 `README.md` 中明确了收入合并计算逻辑
- 定义了新的表头结构：月份｜税前总收入｜社保｜税｜税后总收入｜工资｜奖金｜备注
- 明确了图表显示要求

### 2. 增强税务计算函数 ✅

修改 `src/lib/tax.ts` 中的 `calcMonthlyWithholdingCumulative` 函数：

- 新增返回字段：`socialInsuranceThisMonth`, `housingFundThisMonth`, `totalDeductionsThisMonth`
- 改进住房公积金计算逻辑
- 提供更详细的扣除信息

### 3. 优化收入预测表格 ✅

修改 `src/app/(dashboard)/income/page.tsx`：

- 使用新的 8 列表头结构
- 添加颜色区分：社保(蓝色)、税(红色)、税后收入(绿色)、奖金(橙色)
- 突出显示重要数据（税前总收入、税后总收入）

### 4. 简化图表显示 ✅

- **柱状图**：只显示"税前总收入"和"税后总收入"两个数据系列
- **折线图**：显示"累计税前收入"和"累计税后收入"趋势
- 移除了过于复杂的工资/奖金分解显示

### 5. 验证奖金发放逻辑 ✅

确认了以下逻辑正确实现：

- 奖金 API 使用 `endOfMonth()` 函数将任意日期转换为该月最后一天
- 预测 API 正确匹配月份中的奖金数据
- 工资和奖金合并计算税费和社保

## 测试验证

### API 数据结构验证 ✅

```bash
curl "http://localhost:4000/api/income/forecast?start=2025-01&end=2025-03" | jq '.results[2]'
```

返回结果包含完整的扣除信息：

- `grossThisMonth`: 55000 (工资 20000 + 奖金 35000)
- `socialInsuranceThisMonth`: 3150 (社保扣除)
- `housingFundThisMonth`: 3600 (公积金扣除)
- `totalDeductionsThisMonth`: 6750 (总扣除)
- `taxThisMonth`: 2111.25 (个税)
- `net`: 46138.75 (税后收入)

### 奖金发放时机验证 ✅

- 3 月份正确显示了奖金数据和"奖金"标记
- 奖金与工资合并计算，税费按合并后的总收入计算
- 符合"自然月月底发放"的需求

## 用户体验改进

### 表格显示优化

1. **信息层次清晰**：税前总收入和税后总收入用粗体突出
2. **颜色语义化**：社保(蓝)、税(红)、税后收入(绿)、奖金(橙)
3. **数据完整性**：显示收入构成的完整分解

### 图表简化

1. **柱状图专注核心**：只显示最重要的税前税后对比
2. **折线图显示趋势**：累计收入变化一目了然
3. **避免信息过载**：移除了过于复杂的分类显示

## 技术实现亮点

1. **向后兼容**：保持了旧 API 的兼容性，只是增加了新字段
2. **计算准确性**：正确处理社保基数上下限、住房公积金计算
3. **数据一致性**：确保前端显示与后端计算完全一致
4. **性能优化**：在现有 API 基础上增强，无需重写核心逻辑

## 结果

现在用户可以清晰地看到：

- ✅ 每月的完整收入构成（工资+奖金）
- ✅ 详细的扣除明细（社保+税费）
- ✅ 奖金按月底发放并正确合并计算
- ✅ 简洁明了的图表趋势展示

完全满足了用户的需求！
