# 个人财富管理系统需求文档

## 需求描述

### 个人收入管理

1. **收入记录**：记录每月的税前收入，并且支持季度奖金、年度奖金的录入，所有收入均为税前收入。
2. **税后收入计算**：根据税前收入，计算税后收入，考虑到中国的社保和个税等扣除。
3. **收入管理表单**：提供一个表单用于填写和管理收入信息。
4. **收入预测功能**：系统应支持收入预测功能。根据历史收入记录、税务变动、奖金发放等信息，预测未来几个月的税前收入和税后收入。支持设置不同的时间段进行预测（例如三个月、六个月、一年等）。
5. **多币种支持与汇率计算**：需要支持多币种收入管理，并且自动计算汇率。

### 记录与更新管理

1. **收入记录历史管理**：每次调整收入时，系统需要保存改动时间和生效时间，能够查看所有历史更新记录。
2. **奖金管理**：新增奖金录入功能，奖金发放需具备生效日期。奖金应当与工资合并发放，并计算税收。奖金按特定时期生效，支持提前录入未来的奖金。
3. **收入管理生效日期**：所有收入记录，包括工资和奖金发放，都应按照每个自然月的最后一天来处理。

### 估值快照与历史记录

1. **估值快照更新**：在估值快照页面添加新估值时，需要在下方展示所有更新历史。如果更新记录超过 50 行，则进行分页展示。
2. **现金流与交易记录历史**：现金流、交易等记录也遵循相同的历史记录管理和分页逻辑。

### 税务参数配置

1. **税务政策记录**：税务参数配置需要记录每一项政策，并且有明确的生效日期。即便是未来生效的税务政策，也可以提前录入系统。
2. **税务信息排序**：税务政策应根据生效日期进行排序，支持查看历史和即将生效的政策。
3. **动态更新**：在税务政策变更时，需要能够自动更新预测收入时所使用的税务信息。

### 收入预测功能

1. **收入预测逻辑**：根据历史收入记录、税务变动及生效日期，预测未来的税前税后收入。若税务信息有变动，系统需要重新计算税后收入。
2. **变动点标注**：在收入预测的列表上，标注出所有变动点，例如工资变动、奖金发放或税务调整。
3. **收入合并计算**：所有奖金和工资都在自然月月底合并发放，共同计算税费和社保。例如，2025 年 8 月 19 日的奖金会与 8 月的工资合并，作为 8 月的总收入计算税率。
4. **收入预测表格**：表头为"月份｜税前总收入｜社保｜税｜税后总收入｜工资｜奖金｜备注"，清晰显示每月收入构成和扣除明细。
5. **图表展示**：
   - **柱状图**：展示每月的税前总收入和税后总收入
   - **折线图**：展示所选时间段内的税前累计收入和税后累计收入变化趋势

---

## 投资管理系统

1. **账户管理**：提供多个账户管理，能够记录账户的初始金额和所有资金变动（注资和提现）。
2. **投资收益计算**：定期更新账户的市值，并根据账户的出入金记录计算每个账户的真实投资收益率和收益额。
3. **投资记录管理**：所有的资金变动、收益更新都需要有详细的记录，并且支持按时间排序。

---

## 技术要求

1. **数据库设计**：由于系统用户较少，可以使用轻量级的数据库，不需要过于复杂的数据库设计。
2. **技术栈**：
   - 后端：基于 **Node.js** 和 **TypeScript** 开发。
   - 前端：使用 **React** 开发，CSS 使用 **TailwindCSS**（版本 4.x）。
   - 后端接口：提供 **RESTful API** 接口，前端通过接口与后端交互。可以考虑使用 **Next.js** 进行前后端一体化开发，但需进一步分析是否适合项目需求。
3. **组件库**：前端使用 **Shadcn UI** 组件库。

---

## 运行与测试

- 安装依赖：
  - `pnpm i`（或 `npm i`）
- 生成 Prisma Client：
  - `npx prisma generate`
- 同步数据库（本地 SQLite）：
  - `npx prisma migrate dev --skip-seed`
- 运行测试：
  - 全量：`npx -y vitest run`
  - 单测：`npx -y vitest run src/tests/<file>.test.ts`

### 关键 API（示例）

- 税务参数刷新（杭州演示）：
  - `POST /api/config/tax-params/refresh?city=Hangzhou&year=2025`
- 工资变更：
  - `POST /api/income/changes`，字段：`city`、`grossMonthly`、`effectiveFrom`
- 奖金计划（按月末生效）：
  - `POST /api/income/bonus`，字段：`city`、`amount`、`effectiveDate`
- 收入预测（按月末配置逐月计算，标注变动点）：
  - `GET /api/income/forecast?year=2025&city=Hangzhou`
- 月度计算与年度汇总：
  - `POST /api/income/calculate`，`GET /api/income/calculate?userId=...&year=2025`
- 估值快照分页：
  - `GET /api/accounts/{id}/snapshots?page=1&pageSize=50`

## 其他需求

1. **分页功能**：对于估值快照、现金流、交易记录等信息，若记录超过 50 行，需进行分页展示。
2. **历史记录管理**：所有重要数据（如收入变动、税务调整、投资变动等）均需保存历史记录，便于查看和追溯。
