/**
 * 收入历史测试文件
 * 测试收入记录的有效日期对齐功能
 */

import { describe, it, expect, vi, beforeAll } from "vitest";
import { prisma } from "@/lib/prisma";
import { endOfMonth } from "@/lib/date";

// 测试用户常量
const MOCK_UID = "test-user-1";
const EMAIL = "mock-user@example.com";

// 模拟会话模块，返回固定的用户ID
vi.mock("@/lib/session", () => ({ getCurrentUser: async () => MOCK_UID }));

/**
 * 收入历史有效日期对齐测试套件
 */
describe("income history effective date alignment", () => {
  // 在所有测试之前执行，创建测试用户
  beforeAll(async () => {
    await prisma.user.upsert({
      where: { email: EMAIL },
      update: {},
      create: { id: MOCK_UID, email: EMAIL, password: "x" },
    });
  });

  /**
   * 测试月度收入API在未提供有效日期时是否将变更设置为月末
   */
  it("monthly API sets effective change to month end when not provided", async () => {
    const user = await prisma.user.findUnique({ where: { email: EMAIL } });
    const year = 2025;
    const month = 2;
    
    // 创建月度收入API请求
    const req = new Request("http://localhost/api/income/monthly", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ city: "Hangzhou", year, month, gross: 20000 }),
    });
    
    // 导入并调用月度收入API路由
    const mod = await import("@/app/api/income/monthly/route");
    // 模拟 session 的 getCurrentUser：直接写入记录，这里绕过鉴权按 prisma 验证
    await mod.POST(req as any);
    
    // 查询最新的收入变更记录
    const changes = await prisma.incomeChange.findMany({
      where: { userId: user!.id },
      orderBy: { createdAt: "desc" },
      take: 1,
    });
    
    // 验证记录是否存在
    expect(changes.length).toBe(1);
    
    // 验证有效日期是否正确设置为月末
    const eff = changes[0].effectiveFrom;
    expect(eff.toISOString().slice(0, 10)).toBe(
      endOfMonth(new Date(year, month - 1, 1))
        .toISOString()
        .slice(0, 10)
    );
  });

  /**
   * 测试奖金API是否将有效日期标准化为月末
   */
  it("bonus API normalizes effectiveDate to month end", async () => {
    const user = await prisma.user.findUnique({ where: { email: EMAIL } });
    
    // 创建奖金API请求
    const req = new Request("http://localhost/api/income/bonus", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        city: "Hangzhou",
        amount: 5000,
        effectiveDate: "2025-03-02",
      }),
    });
    
    // 导入并调用奖金API路由
    const mod = await import("@/app/api/income/bonus/route");
    await mod.POST(req as any);
    
    // 查询最新的奖金计划记录
    const list = await prisma.bonusPlan.findMany({
      where: { userId: user!.id },
      orderBy: { createdAt: "desc" },
      take: 1,
    });
    
    // 验证记录是否存在
    expect(list.length).toBe(1);
    
    // 验证有效日期是否正确标准化为月末
    const eff = list[0].effectiveDate;
    expect(eff.toISOString().slice(0, 10)).toBe("2025-03-31");
  });
});
