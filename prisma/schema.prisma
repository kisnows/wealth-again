generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

/// 用户表 - 系统的核心用户实体
model User {
  id        String   @id @default(uuid()) /// 用户唯一标识符，使用UUID
  email     String   @unique /// 用户邮箱，用于登录和身份识别，必须唯一
  password  String /// 用户密码，加密存储
  name      String? /// 用户姓名，可选字段
  isActive  Boolean  @default(true) /// 用户账户是否激活
  lastLoginAt DateTime? /// 最后登录时间
  createdAt DateTime @default(now()) /// 用户创建时间，自动设置为当前时间
  updatedAt DateTime @updatedAt /// 用户信息更新时间

  // 关联关系
  accounts      Account[] /// 用户拥有的投资账户列表
  incomes       IncomeRecord[] /// 用户的收入记录
  incomeChanges IncomeChange[] /// 用户的收入变更记录
  bonusPlans    BonusPlan[] /// 用户的奖金计划
  sessions      Session[] /// 用户会话记录
  auditLogs     AuditLog[] /// 审计日志
  notifications Notification[] /// 用户通知
  preference    UserPreference? /// 用户偏好设置
  backupRecords BackupRecord[] /// 数据备份记录

  @@index([email])
  @@index([isActive])
}

/// 投资账户表 - 用户的各种投资账户（如券商账户、基金账户等）
model Account {
  id           String   @id @default(uuid()) /// 账户唯一标识符
  userId       String /// 所属用户ID，外键关联User表
  name         String /// 账户名称（如"招商证券账户"）
  baseCurrency String   @default("CNY") /// 账户基础货币，默认人民币
  createdAt    DateTime @default(now()) /// 账户创建时间

  // 关联关系
  user         User                @relation(fields: [userId], references: [id]) /// 所属用户
  transactions Transaction[] /// 账户下的所有交易记录
  lots         Lot[] /// 账户下的持仓批次
  snapshots    ValuationSnapshot[] /// 账户估值快照

  @@unique([userId, name]) /// 同一用户下账户名称必须唯一
}

/// 金融工具表 - 股票、基金、债券等投资标的
model Instrument {
  id        String   @id @default(uuid()) /// 金融工具唯一标识符
  symbol    String /// 交易代码（如"000001"、"AAPL"）
  market    String? /// 交易市场（如"SZ"、"NASDAQ"），可选
  currency  String   @default("CNY") /// 计价货币，默认人民币
  type      String   @default("EQUITY") /// 工具类型（股票EQUITY、基金FUND、债券BOND等）
  createdAt DateTime @default(now()) /// 创建时间

  // 关联关系
  lots         Lot[] /// 相关的持仓批次
  prices       Price[] /// 历史价格数据
  transactions Transaction[] /// 相关的交易记录

  @@index([symbol]) /// 按交易代码建立索引，提高查询效率
}

/// 交易记录表 - 记录所有的买卖、转账等交易操作
model Transaction {
  id           String   @id @default(uuid()) /// 交易唯一标识符
  accountId    String /// 所属账户ID，外键关联Account表
  type         String /// 交易类型（BUY买入、SELL卖出、DEPOSIT存款、WITHDRAW取款等）
  tradeDate    DateTime /// 交易日期
  instrumentId String? /// 关联的金融工具ID，现金交易时为空
  quantity     Decimal? /// 交易数量（股数、份额等），现金交易时为空
  price        Decimal? /// 交易价格，现金交易时为空
  cashAmount   Decimal? /// 现金变动金额（正数表示流入，负数表示流出）
  currency     String /// 交易货币
  fee          Decimal? @default(0) /// 交易手续费，默认为0
  tax          Decimal? @default(0) /// 交易税费，默认为0
  lotId        String? /// 关联的持仓批次ID，用于FIFO等成本计算
  note         String? /// 交易备注信息
  createdAt    DateTime @default(now()) /// 记录创建时间

  // 关联关系
  account    Account     @relation(fields: [accountId], references: [id]) /// 所属账户
  instrument Instrument? @relation(fields: [instrumentId], references: [id]) /// 关联的金融工具
  lot        Lot?        @relation(fields: [lotId], references: [id]) /// 关联的持仓批次

  @@index([accountId, tradeDate]) /// 按账户和交易日期建立复合索引
}

/// 持仓批次表 - 记录每次买入形成的持仓批次，用于成本计算
model Lot {
  id           String   @id @default(uuid()) /// 批次唯一标识符
  accountId    String /// 所属账户ID
  instrumentId String /// 持仓的金融工具ID
  qty          Decimal /// 持仓数量
  costPerUnit  Decimal /// 单位成本价格
  openDate     DateTime /// 建仓日期
  method       String   @default("FIFO") /// 成本计算方法（FIFO先进先出、LIFO后进先出等）

  // 关联关系
  account      Account       @relation(fields: [accountId], references: [id]) /// 所属账户
  instrument   Instrument    @relation(fields: [instrumentId], references: [id]) /// 持仓的金融工具
  transactions Transaction[] /// 相关的交易记录
}

/// 账户估值快照表 - 定期记录账户总价值，用于性能分析
model ValuationSnapshot {
  id         String   @id @default(uuid()) /// 快照唯一标识符
  accountId  String /// 所属账户ID
  asOf       DateTime /// 快照时间点
  totalValue Decimal /// 账户总价值
  breakdown  String /// 价值分解详情（JSON格式，包含各持仓的市值）
  createdAt  DateTime @default(now()) /// 快照创建时间

  // 关联关系
  account Account @relation(fields: [accountId], references: [id]) /// 所属账户

  @@unique([accountId, asOf]) /// 同一账户在同一时间点只能有一个快照
}

/// 价格数据表 - 存储金融工具的历史价格信息
model Price {
  id           String   @id @default(uuid()) /// 价格记录唯一标识符
  instrumentId String /// 关联的金融工具ID
  asOf         DateTime /// 价格日期
  close        Decimal /// 收盘价
  currency     String /// 价格货币

  // 关联关系
  instrument Instrument @relation(fields: [instrumentId], references: [id]) /// 关联的金融工具

  @@unique([instrumentId, asOf]) /// 同一工具在同一日期只能有一个价格记录
}

/// 汇率表 - 存储不同货币之间的汇率信息
model FxRate {
  id    String   @id @default(uuid()) /// 汇率记录唯一标识符
  base  String /// 基础货币（如"USD"）
  quote String /// 计价货币（如"CNY"）
  asOf  DateTime /// 汇率日期
  rate  Decimal /// 汇率值（1单位基础货币=rate单位计价货币）

  @@unique([base, quote, asOf]) /// 同一货币对在同一日期只能有一个汇率记录
}

/// 系统配置表 - 存储系统级配置参数（如税率参数等）
model Config {
  id            String    @id @default(uuid()) /// 配置记录唯一标识符
  key           String /// 配置键名（如"tax.rate.shanghai"）
  value         String /// 配置值（JSON格式存储复杂配置）
  effectiveFrom DateTime /// 配置生效开始时间
  effectiveTo   DateTime? /// 配置生效结束时间，null表示永久有效
  createdAt     DateTime  @default(now()) /// 配置创建时间

  @@index([key, effectiveFrom]) /// 按配置键名和生效时间建立复合索引
  @@index([key, effectiveFrom, effectiveTo]) /// 按时间范围查询建立索引
}

/// 税率表 - 存储个人所得税税率档次信息
model TaxBracket {
  id             String    @id @default(uuid()) /// 税率档次唯一标识符
  city           String /// 适用城市
  minIncome      Decimal /// 收入区间下限（年度）
  maxIncome      Decimal? /// 收入区间上限，null表示无上限
  taxRate        Decimal /// 税率（小数，如0.03表示3%）
  quickDeduction Decimal /// 速算扣除数
  effectiveFrom  DateTime /// 生效开始时间
  effectiveTo    DateTime? /// 生效结束时间，null表示永久有效
  createdAt      DateTime  @default(now()) /// 创建时间

  @@index([city, effectiveFrom]) /// 按城市和生效时间建立索引
  @@index([city, effectiveFrom, effectiveTo]) /// 按时间范围查询建立索引
}

/// 社保公积金配置表 - 存储各城市的社保公积金政策参数
model SocialInsuranceConfig {
  id   String @id @default(uuid()) /// 配置唯一标识符
  city String /// 适用城市

  // 社保相关
  socialMinBase    Decimal /// 社保最低缴费基数
  socialMaxBase    Decimal /// 社保最高缴费基数
  pensionRate      Decimal /// 养老保险个人缴费比例
  medicalRate      Decimal /// 医疗保险个人缴费比例
  unemploymentRate Decimal /// 失业保险个人缴费比例

  // 公积金相关
  housingFundMinBase Decimal /// 公积金最低缴费基数
  housingFundMaxBase Decimal /// 公积金最高缴费基数
  housingFundRate    Decimal /// 公积金个人缴费比例

  effectiveFrom DateTime /// 生效开始时间
  effectiveTo   DateTime? /// 生效结束时间，null表示永久有效
  createdAt     DateTime  @default(now()) /// 创建时间

  @@unique([city, effectiveFrom]) /// 同一城市在同一时间点只能有一个配置
  @@index([city, effectiveFrom, effectiveTo]) /// 按时间范围查询建立索引
}

/// 收入记录表 - 记录用户每月的收入详情
model IncomeRecord {
  id     String   @id @default(uuid()) /// 收入记录唯一标识符
  userId String /// 所属用户ID
  city   String /// 工作城市（影响税率计算）
  year   Int /// 收入年份
  month  Int /// 收入月份（1-12）
  gross  Decimal /// 税前总收入
  bonus  Decimal? @default(0) /// 当月奖金（如季度奖、年终奖等）

  // 社保公积金相关
  socialInsuranceBase Decimal? /// 社保缴费基数
  housingFundBase     Decimal? /// 公积金缴费基数
  socialInsurance     Decimal? @default(0) /// 实际社保缴费金额
  housingFund         Decimal? @default(0) /// 实际公积金缴费金额

  // 专项附加扣除（简化为总额）
  specialDeductions Decimal? @default(0) /// 专项附加扣除总额（含子女教育、继续教育、大病医疗、住房贷款利息、住房租金、赡养老人、婴幼儿照护等）

  // 其他扣除
  otherDeductions  Decimal? @default(0) /// 其他法定扣除
  charityDonations Decimal? @default(0) /// 公益慈善捐赠

  // 计算结果
  taxableIncome Decimal? /// 应纳税所得额
  incomeTax     Decimal? /// 应缴个人所得税
  netIncome     Decimal? /// 税后收入

  overrides String? /// 覆盖参数（JSON格式，用于特殊情况）
  createdAt DateTime @default(now()) /// 记录创建时间
  updatedAt DateTime @updatedAt /// 记录更新时间

  // 关联关系
  user User @relation(fields: [userId], references: [id]) /// 所属用户

  @@unique([userId, year, month]) /// 同一用户在同一年月只能有一条收入记录
  @@index([userId, year]) /// 按用户和年份建立索引，便于年度汇算
}

/// 收入变更记录表 - 记录用户薪资的历史变更
model IncomeChange {
  id            String   @id @default(uuid()) /// 收入变更记录唯一标识符
  userId        String /// 所属用户ID
  city          String /// 工作城市
  grossMonthly  Decimal /// 新的月度税前收入
  effectiveFrom DateTime /// 变更生效日期
  createdAt     DateTime @default(now()) /// 记录创建时间

  // 关联关系
  user User @relation(fields: [userId], references: [id]) /// 所属用户

  @@index([userId, effectiveFrom]) /// 按用户和生效日期建立复合索引
}

/// 奖金计划表 - 记录用户的奖金发放计划
model BonusPlan {
  id            String   @id @default(uuid()) /// 奖金计划唯一标识符
  userId        String /// 所属用户ID
  city          String /// 工作城市
  amount        Decimal /// 奖金金额
  effectiveDate DateTime /// 奖金发放日期
  createdAt     DateTime @default(now()) /// 记录创建时间

  // 关联关系
  user User @relation(fields: [userId], references: [id]) /// 所属用户

  @@index([userId, effectiveDate]) /// 按用户和发放日期建立复合索引
}

/// 用户会话表 - 管理用户登录会话
model Session {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique /// JWT token或会话token
  expiresAt DateTime /// 过期时间
  ipAddress String? /// IP地址
  userAgent String? /// 用户代理
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 关联关系
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

/// 审计日志表 - 记录系统操作日志
model AuditLog {
  id          String   @id @default(uuid())
  userId      String? /// 操作用户ID，系统操作时可为空
  action      String /// 操作类型（CREATE、UPDATE、DELETE等）
  resource    String /// 操作资源类型（User、Account、Transaction等）
  resourceId  String? /// 操作资源ID
  oldValues   String? /// 操作前的值（JSON格式）
  newValues   String? /// 操作后的值（JSON格式）
  ipAddress   String? /// IP地址
  userAgent   String? /// 用户代理
  createdAt   DateTime @default(now())

  // 关联关系
  user User? @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([resource, resourceId])
  @@index([createdAt])
}

/// 系统通知表 - 管理用户通知
model Notification {
  id        String   @id @default(uuid())
  userId    String
  type      String /// 通知类型（INFO、WARNING、ERROR、SUCCESS）
  title     String /// 通知标题
  message   String /// 通知内容
  isRead    Boolean  @default(false) /// 是否已读
  data      String? /// 额外数据（JSON格式）
  expiresAt DateTime? /// 过期时间
  createdAt DateTime @default(now())

  // 关联关系
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([createdAt])
}

/// 用户偏好设置表 - 存储用户个性化设置
model UserPreference {
  id          String   @id @default(uuid())
  userId      String   @unique
  theme       String   @default("light") /// 主题设置
  language    String   @default("zh-CN") /// 语言设置
  timezone    String   @default("Asia/Shanghai") /// 时区设置
  currency    String   @default("CNY") /// 默认货币
  dateFormat  String   @default("YYYY-MM-DD") /// 日期格式
  numberFormat String  @default("en-US") /// 数字格式
  pageSize    Int      @default(20) /// 默认分页大小
  dashboardConfig String? /// 仪表盘配置（JSON格式）
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // 关联关系
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

/// 系统设置表 - 全局系统设置
model SystemSetting {
  id          String   @id @default(uuid())
  key         String   @unique /// 设置键名
  value       String /// 设置值（JSON格式）
  description String? /// 设置描述
  category    String   @default("general") /// 设置分类
  isPublic    Boolean  @default(false) /// 是否为公开设置（前端可见）
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([category])
}

/// 数据备份记录表 - 记录数据备份信息
model BackupRecord {
  id          String   @id @default(uuid())
  userId      String? /// 触发备份的用户ID，null表示系统自动备份
  fileName    String /// 备份文件名
  filePath    String /// 备份文件路径
  fileSize    BigInt /// 备份文件大小（字节）
  type        String   @default("FULL") /// 备份类型（FULL、INCREMENTAL）
  status      String   @default("PENDING") /// 备份状态（PENDING、SUCCESS、FAILED）
  errorMessage String? /// 错误信息
  createdAt   DateTime @default(now())
  completedAt DateTime? /// 完成时间

  // 关联关系
  user User? @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}
